<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Object Manager</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:"Poppins",sans-serif; }
    body {
      background: linear-gradient(135deg,#0f0f0f,#1c1c1c);
      color:#fff; display:flex; flex-direction:column; align-items:center;
      padding:20px; min-height:100vh;
    }
    .container { max-width: 800px; width: 100%; }
    input, button {
      padding:12px 15px; margin:10px 0; border-radius:10px;
      border:none; outline:none; font-size:1rem;
    }
    input { width:100%; }
    button { background:#ff6600; color:#fff; font-weight:bold; cursor:pointer; transition:background .3s, transform .2s; }
    button:hover { background:#ff8533; transform:scale(1.05); }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:12px; border-bottom:1px solid rgba(255,255,255,0.1); text-align:left; }
    td[contenteditable="true"] { background:#1e1e1e; border-radius:6px; }
    .total { margin:10px 0 20px; font-size:1.2rem; font-weight:600; }
    .actions { display:flex; gap:8px; }
    .muted { opacity:.7; }
    .error { color: #ff6b6b; margin-top: 10px; }
    .success { color: #58d68d; margin-top: 10px; }
    @media (max-width: 600px) { th, td { font-size:.9rem; } }
  </style>
</head>
<body>

  <h1>Object Manager</h1>
  <div class="total">Total: â‚¹0</div>

  <div class="container">
    <div class="form-container">
      <input type="text" id="name" placeholder="Object Name" />
      <input type="number" id="price" placeholder="Price" min="1" step="0.01" />
      <input type="number" id="quantity" placeholder="Quantity" min="1" value="1" />
      <button id="addBtn">Add</button>
      <div id="status" class="muted"></div>
    </div>

    <table id="objectTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Price (â‚¹)</th>
          <th>Quantity</th>
          <th>Total (â‚¹)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  const API_URL = "https://object-manager.onrender.com/api/objects";

  const statusEl = document.getElementById("status");
  const tbody = document.querySelector("#objectTable tbody");
  const totalEl = document.querySelector(".total");
  const addBtn = document.getElementById("addBtn");

  const isValidObjectId = (id) => /^[a-fA-F0-9]{24}$/.test(id);

  const toNumber = (v, fallback = 0) => {
    const n = typeof v === "number" ? v : parseFloat(String(v).replace(/[, ]+/g, ""));
    return Number.isFinite(n) ? n : fallback;
  };

  function showStatus(msg, kind = "muted") {
    statusEl.className = kind;
    statusEl.textContent = msg;
    if (kind !== "muted") {
      setTimeout(() => { statusEl.className = "muted"; statusEl.textContent = ""; }, 2000);
    }
  }

  async function fetchObjects() {
    try {
      const res = await fetch(API_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`GET failed: ${res.status}`);
      const data = await res.json();
      renderTable(data);
    } catch (err) {
      console.error(err);
      showStatus("Failed to load items.", "error");
    }
  }

  function updateTotal(objects) {
    const total = objects.reduce((sum, obj) => {
      const price = toNumber(obj.price);
      const qty = toNumber(obj.quantity, 0);
      return sum + (price * qty);
    }, 0);
    totalEl.textContent = `Total: â‚¹${total}`;
  }

  function renderTable(objects) {
    tbody.innerHTML = "";
    objects.forEach(obj => {
      const id = obj._id || obj.id; // prefer _id
      const price = toNumber(obj.price);
      const qty = toNumber(obj.quantity, 0);
      const tr = document.createElement("tr");
      tr.dataset.id = id;

      const nameTd = document.createElement("td");
      nameTd.contentEditable = "true";
      nameTd.textContent = obj.name ?? "";

      const priceTd = document.createElement("td");
      priceTd.contentEditable = "true";
      priceTd.textContent = String(price);

      const qtyTd = document.createElement("td");
      qtyTd.contentEditable = "true";
      qtyTd.textContent = String(qty);

      const totalTd = document.createElement("td");
      totalTd.textContent = String(price * qty);

      const actionsTd = document.createElement("td");
      actionsTd.className = "actions";
      const delBtn = document.createElement("button");
      delBtn.textContent = "ðŸ—‘ Delete";
      delBtn.addEventListener("click", () => deleteObject(id));
      actionsTd.appendChild(delBtn);

      tr.appendChild(nameTd);
      tr.appendChild(priceTd);
      tr.appendChild(qtyTd);
      tr.appendChild(totalTd);
      tr.appendChild(actionsTd);
      tbody.appendChild(tr);

      // save edits when a cell loses focus
      const saveIfChanged = async () => {
        const newName = nameTd.textContent.trim();
        const newPrice = toNumber(priceTd.textContent);
        const newQty = toNumber(qtyTd.textContent);

        // Update the row total immediately (optimistic UI)
        totalTd.textContent = String(newPrice * newQty);

        await updateObject(id, { name: newName, price: newPrice, quantity: newQty });
      };

      nameTd.addEventListener("blur", saveIfChanged);
      priceTd.addEventListener("blur", saveIfChanged);
      qtyTd.addEventListener("blur", saveIfChanged);
    });

    updateTotal(objects);
  }

  addBtn.addEventListener("click", addObject);

  async function addObject() {
    const name = document.getElementById("name").value.trim();
    const price = toNumber(document.getElementById("price").value);
    const quantity = toNumber(document.getElementById("quantity").value, 1);

    if (!name || !Number.isFinite(price) || !Number.isFinite(quantity) || quantity < 0) {
      alert("Please enter a valid name, price, and quantity.");
      return;
    }

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, price, quantity })
      });
      if (!res.ok) throw new Error(`POST failed: ${res.status}`);
      showStatus("Item added.", "success");

      document.getElementById("name").value = "";
      document.getElementById("price").value = "";
      document.getElementById("quantity").value = 1;

      await fetchObjects();
    } catch (err) {
      console.error(err);
      showStatus("Failed to add item.", "error");
    }
  }

  async function updateObject(id, updatedData) {
    if (!isValidObjectId(id)) {
      console.warn("Invalid MongoDB ObjectId:", id);
      showStatus("Invalid item ID (cannot update).", "error");
      return;
    }

    // ensure numeric
    updatedData.price = toNumber(updatedData.price);
    updatedData.quantity = toNumber(updatedData.quantity);

    try {
      const res = await fetch(`${API_URL}/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updatedData)
      });
      if (!res.ok) throw new Error(`PUT failed: ${res.status}`);
      showStatus("Item updated.", "success");
      // refresh list to sync with server and recompute totals
      await fetchObjects();
    } catch (err) {
      console.error(err);
      showStatus("Failed to update item.", "error");
    }
  }

  async function deleteObject(id) {
    if (!isValidObjectId(id)) {
      console.warn("Invalid MongoDB ObjectId:", id);
      showStatus("Invalid item ID (cannot delete).", "error");
      return;
    }
    if (!confirm("Are you sure you want to delete this item?")) return;

    try {
      const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
      if (res.status === 404) {
        showStatus("Item not found (maybe already deleted).", "error");
      } else if (!res.ok) {
        throw new Error(`DELETE failed: ${res.status}`);
      } else {
        showStatus("Item deleted.", "success");
      }
      await fetchObjects();
    } catch (err) {
      console.error(err);
      showStatus("Failed to delete item.", "error");
    }
  }

  // initial load
  fetchObjects();
</script>
</body>
</html>
